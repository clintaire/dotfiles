#!/bin/bash

# Apply current Omarchy theme to i3 without cycling
# This updates i3 config and i3status with the current theme colors

CURRENT_THEME_LINK="$HOME/.config/omarchy/current/theme"

if [ ! -L "$CURRENT_THEME_LINK" ]; then
    echo "No theme set. Current theme link not found."
    exit 1
fi

CURRENT_THEME=$(basename "$(readlink "$CURRENT_THEME_LINK")")
THEME_I3_CONF="$(readlink "$CURRENT_THEME_LINK")/i3.conf"

if [ ! -f "$THEME_I3_CONF" ]; then
    echo "Theme i3.conf not found: $THEME_I3_CONF"
    exit 1
fi

echo "Applying theme: $CURRENT_THEME"

# Read all bar color variables
declare -A bar_colors
while IFS= read -r line; do
    if [[ $line =~ ^set\ \$bar_([a-z_]+)\ +(\#[0-9a-fA-F]+) ]]; then
        var_name="${BASH_REMATCH[1]}"
        hex_value="${BASH_REMATCH[2]}"
        bar_colors[$var_name]="$hex_value"
    fi
done < "$THEME_I3_CONF"

# Extract color values for i3status
COLOR_GOOD=$(grep -m1 "set \$green" "$THEME_I3_CONF" | awk '{print $3}')
COLOR_DEGRADED=$(grep -m1 "set \$yellow" "$THEME_I3_CONF" | awk '{print $3}')
COLOR_BAD=$(grep -m1 "set \$red" "$THEME_I3_CONF" | awk '{print $3}')

# Update i3 main config with new bar colors
I3_CONFIG="$HOME/.config/i3/config"

# Replace bar colors in i3 config
sed -i "/^        colors {/,/^        }/{
    s|^                background .*|                background ${bar_colors[bg]}|
    s|^                statusline .*|                statusline ${bar_colors[fg]}|
    s|^                separator  .*|                separator  ${bar_colors[separator]}|
    s|^                focused_workspace .*|                focused_workspace  ${bar_colors[focused_bg]} ${bar_colors[focused_bg]} ${bar_colors[focused_fg]}|
    s|^                active_workspace .*|                active_workspace   ${bar_colors[active_bg]} ${bar_colors[active_bg]} ${bar_colors[active_fg]}|
    s|^                inactive_workspace .*|                inactive_workspace ${bar_colors[inactive_bg]} ${bar_colors[inactive_bg]} ${bar_colors[inactive_fg]}|
    s|^                urgent_workspace .*|                urgent_workspace   ${bar_colors[urgent_bg]} ${bar_colors[urgent_bg]} ${bar_colors[urgent_fg]}|
    s|^                binding_mode .*|                binding_mode       ${bar_colors[binding_bg]} ${bar_colors[binding_bg]} ${bar_colors[binding_fg]}|
}" "$I3_CONFIG"

# Generate i3status config with theme colors
cat > "$HOME/.config/i3status/config" << EOF
# i3status configuration file (auto-generated by theme)
# see "man i3status" for documentation

general {
        output_format = "i3bar"
        colors = true
        interval = 5
        color_good = "${COLOR_GOOD:-#a6e3a1}"
        color_degraded = "${COLOR_DEGRADED:-#f9e2af}"
        color_bad = "${COLOR_BAD:-#f38ba8}"
}

order += "wireless _first_"
order += "ethernet _first_"
order += "battery all"
order += "disk /"
order += "load"
order += "memory"
order += "tztime local"

wireless _first_ {
        format_up = "W: (%quality at %essid) %ip"
        format_down = "W: down"
}

ethernet _first_ {
        format_up = "E: %ip (%speed)"
        format_down = "E: down"
}

battery all {
        format = "BAT %percentage %remaining"
        format_down = "No battery"
        status_chr = "âš¡ CHR"
        status_bat = "ðŸ”‹ BAT"
        status_unk = "? UNK"
        status_full = "â˜» FULL"
        path = "/sys/class/power_supply/BAT%d/uevent"
        low_threshold = 10
}

disk "/" {
        format = "%avail"
}

load {
        format = "%1min"
}

memory {
        format = "%used | %available"
        threshold_degraded = "1G"
        format_degraded = "MEMORY < %available"
}

tztime local {
        format = "%Y-%m-%d %H:%M:%S"
}
EOF

# Set wallpaper if feh is installed and wallpaper exists
WALLPAPER_DIR="$(readlink "$CURRENT_THEME_LINK")/backgrounds"
if command -v feh &> /dev/null && [ -d "$WALLPAPER_DIR" ]; then
    WALLPAPER=$(find "$WALLPAPER_DIR" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) | head -n 1)
    if [ -n "$WALLPAPER" ]; then
        feh --bg-fill "$WALLPAPER" &
    fi
fi

# Reload i3 to apply new theme colors
i3-msg reload > /dev/null 2>&1

echo "âœ“ Applied $CURRENT_THEME theme to i3"
